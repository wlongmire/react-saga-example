- name: Build EHR Web
  type: serial
  steps:
    - name: Install dependencies
      service: patient_web_test
      command: yarn install

    - name: Build test app
      service: patient_web_test
      command: yarn build

    - name: Build app
      service: patient_web
      command: echo "Patient Web image built"

    - name: Tests
      type: parallel
      steps:
        - name: Run tests (without e2e)
          service: patient_web_test
          command: yarn test

        - name: Run e2e tests
          service: patient_web_e2e_test
          command: scripts/run_tests_ci.sh

    - name: Push image to Quay.io with `latest` tag
      service: patient_web
      type: push
      image_name: quay.io/lifeco/patient_web
      image_tag: latest
      registry: quay.io
      tag: ^(master|develop|dev)
      encrypted_dockercfg_path: dockercfg.encrypted

    - name: Push image to Quay.io with Git hash tag
      service: patient_web
      type: push
      image_name: quay.io/lifeco/patient_web
      image_tag: "{{.Branch}}_{{.CommitID}}"
      registry: quay.io
      encrypted_dockercfg_path: dockercfg.encrypted


- name: Deploy EHR Web
  type: serial
  steps:
    - name: Copy to Cheap S3 bucket
      # tag: cheap
      service: awsdeployment
      command: aws s3 cp /usr/src/app/build/* s3://patient.life.cheap
    # - name: Invalidate CloudFront Distribution
    #   # tag: cheap
    #   service: awsdeployment
    #   command: aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths "/*"
